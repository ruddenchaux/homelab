---
# IPv6 Public Access — two-phase playbook
#
# Phase 1 (initial setup — run this first):
#   ansible-playbook ansible/playbooks/ipv6.yml --tags phase1
#
#   What it does:
#   - Configures MikroTik DHCPv6-PD client, VLAN IPv6 addresses, RA, firewall
#   - Configures k8s nodes to accept RAs and use stable IPv6 addresses
#   After running: check node IPv6 with `ip -6 addr show scope global` on any k8s node.
#   The prefix assigned to VLAN 30 determines the Cilium pool CIDR.
#
# Phase 2 (after prefix is known and Traefik has an IPv6 LB IP):
#   ansible-playbook ansible/playbooks/ipv6.yml --tags phase2 \
#     -e cilium_l2_ipv6_cidr="2a0d:5600:XXXX:YY30::200/122" \
#     -e mikrotik_traefik_ipv6="2a0d:5600:XXXX:YY30::200"
#
#   What it does:
#   - Updates Cilium LB pool with the IPv6 CIDR (Traefik gets an IPv6 LB IP)
#   - Adds the MikroTik forward firewall rule to allow Cloudflare → Traefik
#   After running: external-dns will detect Traefik's IPv6 and publish AAAA records.

# --- Prerequisites: secrets (always runs unless skipped) ---

- name: Create external-dns Cloudflare secret
  hosts: k8s_control_plane
  tags: [phase1, secrets]
  tasks:
    - name: Create external-dns namespace
      become: false
      ansible.builtin.command: kubectl create namespace external-dns
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: extdns_ns
      changed_when: "'created' in extdns_ns.stdout"
      failed_when: extdns_ns.rc != 0 and 'already exists' not in extdns_ns.stderr

    - name: Create external-dns Cloudflare token secret
      become: false
      ansible.builtin.command: >-
        kubectl create secret generic cloudflare-external-dns
        --namespace external-dns
        --from-literal=token={{ cloudflare_api_token }}
        --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: extdns_secret
      changed_when: "'created' in extdns_secret.stdout or 'configured' in extdns_secret.stdout"
      no_log: true

# --- Phase 1: MikroTik + k8s nodes ---

- name: Configure IPv6 on MikroTik
  hosts: mikrotik
  gather_facts: false
  tags: [phase1, mikrotik]
  roles:
    - mikrotik-ipv6

- name: Configure k8s nodes for stable IPv6 reception
  hosts: k8s
  tags: [phase1, k8s-ipv6]
  roles:
    - k8s-ipv6

# --- Phase 2: Cilium pool + MikroTik Traefik rule ---

- name: Update Cilium LB pool with IPv6 CIDR
  hosts: k8s_control_plane
  tags: [phase2, cilium]
  roles:
    - cilium-l2

- name: Add MikroTik forward rule for Traefik IPv6
  hosts: mikrotik
  gather_facts: false
  tags: [phase2, mikrotik-traefik]
  roles:
    - role: mikrotik-ipv6
      tasks_from: firewall.yml
