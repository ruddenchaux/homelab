---
- name: Configure Cilium L2 load balancing
  hosts: k8s_control_plane
  roles:
    - cilium-l2

- name: Create Authentik secrets
  hosts: k8s_control_plane
  roles:
    - authentik-secrets

- name: Create media secrets
  hosts: k8s_control_plane
  roles:
    - media-secrets

- name: Create Immich secrets
  hosts: k8s_control_plane
  roles:
    - immich-secrets

- name: Bootstrap ArgoCD and GitOps
  hosts: k8s_control_plane
  pre_tasks:
    - name: Load secrets
      community.sops.load_vars:
        file: "{{ playbook_dir }}/../secrets.sops.yml"
      no_log: true
  roles:
    - argocd

- name: Configure Authentik SSO
  hosts: k8s_control_plane
  roles:
    - authentik-config

- name: Initialize Immich admin account
  hosts: k8s_control_plane
  pre_tasks:
    - name: Load secrets
      community.sops.load_vars:
        file: "{{ playbook_dir }}/../secrets.sops.yml"
      no_log: true
  roles:
    - role: immich-init
      vars:
        immich_admin_email: "{{ acme_email }}"

- name: Configure media stack inter-service connections
  hosts: k8s_control_plane
  tags:
    - media-config
  roles:
    - media-config
