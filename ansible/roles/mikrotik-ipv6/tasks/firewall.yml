---
# IPv6 firewall â€” every device gets a public IPv6 address, so this is non-optional.
# Rules use comments as idempotency keys (check-then-add pattern).
# The forward rule for Traefik is only added when mikrotik_traefik_ipv6 is set
# (Phase 2, after Cilium assigns an IPv6 LB IP to Traefik).

- name: Check existing IPv6 firewall filter rules
  community.routeros.command:
    commands:
      - /ipv6 firewall filter print
  register: _ip6_fw

# --- Input chain ---

- name: fw6-input: accept established/related/untracked
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=input action=accept
        connection-state=established,related,untracked
        comment="fw6-input-established"
  when: "'fw6-input-established' not in _ip6_fw.stdout[0]"

- name: fw6-input: drop invalid
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=input action=drop
        connection-state=invalid
        comment="fw6-input-invalid"
  when: "'fw6-input-invalid' not in _ip6_fw.stdout[0]"

- name: fw6-input: accept ICMPv6 (NDP, ping, etc.)
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=input action=accept
        protocol=icmpv6
        comment="fw6-input-icmpv6"
  when: "'fw6-input-icmpv6' not in _ip6_fw.stdout[0]"

- name: fw6-input: accept DHCPv6 replies from link-local (fe80::/10)
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=input action=accept
        protocol=udp dst-port=546
        src-address=fe80::/10
        comment="fw6-input-dhcpv6-reply"
  when: "'fw6-input-dhcpv6-reply' not in _ip6_fw.stdout[0]"

- name: fw6-input: drop everything from non-LAN interfaces
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=input action=drop
        in-interface-list=!LAN
        comment="fw6-input-drop-wan"
  when: "'fw6-input-drop-wan' not in _ip6_fw.stdout[0]"

# --- Forward chain ---

- name: fw6-forward: accept established/related/untracked
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=forward action=accept
        connection-state=established,related,untracked
        comment="fw6-fwd-established"
  when: "'fw6-fwd-established' not in _ip6_fw.stdout[0]"

- name: fw6-forward: drop invalid
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=forward action=drop
        connection-state=invalid
        comment="fw6-fwd-invalid"
  when: "'fw6-fwd-invalid' not in _ip6_fw.stdout[0]"

- name: fw6-forward: accept ICMPv6
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=forward action=accept
        protocol=icmpv6
        comment="fw6-fwd-icmpv6"
  when: "'fw6-fwd-icmpv6' not in _ip6_fw.stdout[0]"

# Allow HTTP/HTTPS inbound from WAN only to Traefik's IPv6 LB address.
# This is Phase 2: only applied once mikrotik_traefik_ipv6 is set.
- name: fw6-forward: allow HTTP/HTTPS from WAN to Traefik IPv6 (Phase 2)
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=forward action=accept
        protocol=tcp
        dst-address={{ mikrotik_traefik_ipv6 }}/128
        dst-port=80,443
        in-interface={{ mikrotik_wan_interface }}
        comment="fw6-fwd-traefik-https"
  when:
    - mikrotik_traefik_ipv6 | length > 0
    - "'fw6-fwd-traefik-https' not in _ip6_fw.stdout[0]"

- name: fw6-forward: allow LAN to WAN (outbound)
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=forward action=accept
        in-interface-list=LAN
        out-interface-list=WAN
        comment="fw6-fwd-lan-to-wan"
  when: "'fw6-fwd-lan-to-wan' not in _ip6_fw.stdout[0]"

- name: fw6-forward: drop everything else
  community.routeros.command:
    commands:
      - >-
        /ipv6 firewall filter add
        chain=forward action=drop
        comment="fw6-fwd-drop-all"
  when: "'fw6-fwd-drop-all' not in _ip6_fw.stdout[0]"
