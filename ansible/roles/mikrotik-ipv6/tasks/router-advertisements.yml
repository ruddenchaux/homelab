---
- name: Check existing ND configurations
  community.routeros.command:
    commands:
      - /ipv6 nd print
  register: _nd_configs

# Disable the default ND entry that RouterOS ships with (sends RAs on all interfaces).
- name: Disable default ND configuration
  community.routeros.command:
    commands:
      - /ipv6 nd set [find default=yes] disabled=yes
  when: "'disabled=no' in _nd_configs.stdout[0]"

# WAN: no RAs toward the internet â€” ra-lifetime=none means hosts won't use
# this router as a default gateway, and advertise-dns=no avoids leaking resolvers.
- name: Add ND entry for WAN interface (suppress RAs toward internet)
  community.routeros.command:
    commands:
      - >-
        /ipv6 nd add
        interface={{ mikrotik_wan_interface }}
        advertise-dns=no
        ra-lifetime=none
        comment="nd-wan-no-ra"
  when: "'nd-wan-no-ra' not in _nd_configs.stdout[0]"

# VLAN interfaces: send RAs with SLAAC prefix (M=no, O=yes for DHCPv6-stateless info).
# dns= advertises Cloudflare IPv6 resolvers. ra-interval keeps announcements frequent
# enough that prefix changes from Starlink propagate quickly.
- name: Add ND/RA for VLAN interfaces
  community.routeros.command:
    commands:
      - >-
        /ipv6 nd add
        interface={{ item }}
        hop-limit=64
        mtu={{ mikrotik_ipv6_ra_mtu }}
        managed-address-configuration=no
        other-configuration=yes
        ra-interval=3m20s-10m
        dns={{ mikrotik_ipv6_dns }}
        comment="nd-ra-{{ item }}"
  loop: "{{ mikrotik_ipv6_vlan_interfaces }}"
  when: "'nd-ra-' ~ item not in _nd_configs.stdout[0]"
