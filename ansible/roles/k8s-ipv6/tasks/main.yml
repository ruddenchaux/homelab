---
# K8s nodes have IP forwarding enabled for pod routing, which causes the kernel
# to set accept_ra=0 by default (prevents accepting Router Advertisements).
# accept_ra=2 overrides this: RAs are accepted even when forwarding is on.
# use_tempaddr=0 disables privacy extensions so the EUI-64 address is stable —
# required for predictable firewall rules, DNS, and Cilium NDP announcements.

- name: Write IPv6 sysctl config
  ansible.builtin.copy:
    dest: /etc/sysctl.d/99-ipv6.conf
    content: |
      # Accept RAs even with IP forwarding enabled (required for k8s nodes)
      net.ipv6.conf.all.accept_ra=2
      net.ipv6.conf.default.accept_ra=2
      net.ipv6.conf.eth0.accept_ra=2
      # Disable privacy extensions — stable EUI-64 address for firewall + DNS
      net.ipv6.conf.all.use_tempaddr=0
      net.ipv6.conf.default.use_tempaddr=0
      net.ipv6.conf.eth0.use_tempaddr=0
    mode: "0644"
  register: ipv6_sysctl

- name: Apply sysctl settings immediately
  ansible.builtin.command: sysctl --system
  changed_when: true
  when: ipv6_sysctl.changed
