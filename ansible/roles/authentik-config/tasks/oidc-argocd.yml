---
# Create ArgoCD OAuth2 provider, application, and k8s secret

- name: Check if ArgoCD OIDC secret exists
  become: false
  ansible.builtin.command: >-
    kubectl get secret {{ authentik_argocd_secret_name }}
    -n {{ authentik_argocd_secret_namespace }}
  environment:
    KUBECONFIG: /home/debian/.kube/config
  register: argocd_secret_check
  changed_when: false
  failed_when: false

- name: Generate ArgoCD client credentials
  when: argocd_secret_check.rc != 0
  block:
    - name: Generate ArgoCD client ID
      become: false
      ansible.builtin.command: openssl rand -hex 20
      register: argocd_client_id_result
      changed_when: false
      no_log: true

    - name: Generate ArgoCD client secret
      become: false
      ansible.builtin.command: openssl rand -hex 40
      register: argocd_client_secret_result
      changed_when: false
      no_log: true

    - name: Set ArgoCD client credentials
      ansible.builtin.set_fact:
        argocd_client_id: "{{ argocd_client_id_result.stdout }}"
        argocd_client_secret: "{{ argocd_client_secret_result.stdout }}"
      no_log: true

- name: Load existing ArgoCD client credentials from secret
  when: argocd_secret_check.rc == 0
  block:
    - name: Read ArgoCD client ID from secret
      become: false
      ansible.builtin.command: >-
        kubectl get secret {{ authentik_argocd_secret_name }}
        -n {{ authentik_argocd_secret_namespace }}
        -o jsonpath='{.data.oidc\.authentik\.clientID}'
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: argocd_existing_id
      changed_when: false
      no_log: true

    - name: Read ArgoCD client secret from secret
      become: false
      ansible.builtin.command: >-
        kubectl get secret {{ authentik_argocd_secret_name }}
        -n {{ authentik_argocd_secret_namespace }}
        -o jsonpath='{.data.oidc\.authentik\.clientSecret}'
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: argocd_existing_secret
      changed_when: false
      no_log: true

    - name: Set ArgoCD client credentials from existing secret
      ansible.builtin.set_fact:
        argocd_client_id: "{{ argocd_existing_id.stdout | b64decode }}"
        argocd_client_secret: "{{ argocd_existing_secret.stdout | b64decode }}"
      no_log: true

- name: Check if ArgoCD OAuth2 provider exists
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/providers/oauth2/?name={{ authentik_argocd_provider_name | urlencode }}"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: argocd_provider_check
  no_log: true

- name: Create ArgoCD OAuth2 provider
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/providers/oauth2/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
      Content-Type: application/json
    body_format: json
    body:
      name: "{{ authentik_argocd_provider_name }}"
      client_type: confidential
      client_id: "{{ argocd_client_id }}"
      client_secret: "{{ argocd_client_secret }}"
      redirect_uris: "{{ authentik_argocd_redirect_uri }}"
      authorization_flow: "{{ authentik_authorization_flow }}"
      authentication_flow: "{{ authentik_authentication_flow }}"
      property_mappings:
        - "{{ authentik_scope_openid }}"
        - "{{ authentik_scope_email }}"
        - "{{ authentik_scope_profile }}"
    status_code: 201
  register: argocd_provider_created
  no_log: true
  when: argocd_provider_check.json.pagination.count == 0

- name: Set ArgoCD provider PK
  ansible.builtin.set_fact:
    argocd_provider_pk: >-
      {{ (argocd_provider_check.json.pagination.count > 0)
         | ternary(argocd_provider_check.json.results[0].pk,
                   argocd_provider_created.json.pk) }}

- name: Check if ArgoCD application exists
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/core/applications/?slug={{ authentik_argocd_app_slug }}"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: argocd_app_check
  no_log: true

- name: Create ArgoCD application
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/core/applications/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
      Content-Type: application/json
    body_format: json
    body:
      name: "{{ authentik_argocd_provider_name }}"
      slug: "{{ authentik_argocd_app_slug }}"
      provider: "{{ argocd_provider_pk }}"
      meta_launch_url: "https://argocd.{{ authentik_domain }}"
    status_code: 201
  no_log: true
  when: argocd_app_check.json.pagination.count == 0

- name: Create ArgoCD OIDC k8s secret
  become: false
  ansible.builtin.command: >-
    kubectl create secret generic {{ authentik_argocd_secret_name }}
    -n {{ authentik_argocd_secret_namespace }}
    --from-literal=oidc.authentik.clientID={{ argocd_client_id }}
    --from-literal=oidc.authentik.clientSecret={{ argocd_client_secret }}
  environment:
    KUBECONFIG: /home/debian/.kube/config
  no_log: true
  when: argocd_secret_check.rc != 0

- name: Patch argocd-secret with OIDC credentials
  become: false
  ansible.builtin.command: >-
    kubectl patch secret argocd-secret
    -n {{ authentik_argocd_secret_namespace }}
    --type merge
    -p '{"stringData":{"oidc.authentik.clientID":"{{ argocd_client_id }}","oidc.authentik.clientSecret":"{{ argocd_client_secret }}"}}'
  environment:
    KUBECONFIG: /home/debian/.kube/config
  no_log: true
