---
# Create Headlamp OAuth2 provider, application, and k8s secret

- name: Check if Headlamp OIDC secret exists
  become: false
  ansible.builtin.command: >-
    kubectl get secret {{ authentik_headlamp_secret_name }}
    -n {{ authentik_headlamp_secret_namespace }}
  environment:
    KUBECONFIG: /home/debian/.kube/config
  register: headlamp_secret_check
  changed_when: false
  failed_when: false

- name: Generate Headlamp client credentials
  when: headlamp_secret_check.rc != 0
  block:
    - name: Generate Headlamp client ID
      become: false
      ansible.builtin.command: openssl rand -hex 20
      register: headlamp_client_id_result
      changed_when: false
      no_log: true

    - name: Generate Headlamp client secret
      become: false
      ansible.builtin.command: openssl rand -hex 40
      register: headlamp_client_secret_result
      changed_when: false
      no_log: true

    - name: Set Headlamp client credentials
      ansible.builtin.set_fact:
        headlamp_client_id: "{{ headlamp_client_id_result.stdout }}"
        headlamp_client_secret: "{{ headlamp_client_secret_result.stdout }}"
      no_log: true

- name: Load existing Headlamp client credentials from secret
  when: headlamp_secret_check.rc == 0
  block:
    - name: Read Headlamp client ID from secret
      become: false
      ansible.builtin.command: >-
        kubectl get secret {{ authentik_headlamp_secret_name }}
        -n {{ authentik_headlamp_secret_namespace }}
        -o jsonpath='{.data.OIDC_CLIENT_ID}'
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: headlamp_existing_id
      changed_when: false
      no_log: true

    - name: Read Headlamp client secret from secret
      become: false
      ansible.builtin.command: >-
        kubectl get secret {{ authentik_headlamp_secret_name }}
        -n {{ authentik_headlamp_secret_namespace }}
        -o jsonpath='{.data.OIDC_CLIENT_SECRET}'
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: headlamp_existing_secret
      changed_when: false
      no_log: true

    - name: Set Headlamp client credentials from existing secret
      ansible.builtin.set_fact:
        headlamp_client_id: "{{ headlamp_existing_id.stdout | b64decode }}"
        headlamp_client_secret: "{{ headlamp_existing_secret.stdout | b64decode }}"
      no_log: true

- name: Check if Headlamp OAuth2 provider exists
  become: false
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/providers/oauth2/?name={{ authentik_headlamp_provider_name | urlencode }}"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: headlamp_provider_check
  no_log: true

- name: Create Headlamp OAuth2 provider
  become: false
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/providers/oauth2/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
      Content-Type: application/json
    body_format: json
    body:
      name: "{{ authentik_headlamp_provider_name }}"
      client_type: confidential
      client_id: "{{ headlamp_client_id }}"
      client_secret: "{{ headlamp_client_secret }}"
      redirect_uris:
        - matching_mode: strict
          url: "{{ authentik_headlamp_redirect_uri }}"
      authorization_flow: "{{ authentik_authorization_flow }}"
      authentication_flow: "{{ authentik_authentication_flow }}"
      invalidation_flow: "{{ authentik_invalidation_flow }}"
      property_mappings:
        - "{{ authentik_scope_openid }}"
        - "{{ authentik_scope_email }}"
        - "{{ authentik_scope_profile }}"
    status_code: 201
  register: headlamp_provider_created
  no_log: true
  when: headlamp_provider_check.json.pagination.count == 0

- name: Set Headlamp provider PK
  ansible.builtin.set_fact:
    headlamp_provider_pk: >-
      {{ (headlamp_provider_check.json.pagination.count > 0)
         | ternary(headlamp_provider_check.json.results[0].pk,
                   headlamp_provider_created.json.pk) }}

- name: Check if Headlamp application exists
  become: false
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/core/applications/?slug={{ authentik_headlamp_app_slug }}"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: headlamp_app_check
  no_log: true

- name: Create Headlamp application
  become: false
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/core/applications/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
      Content-Type: application/json
    body_format: json
    body:
      name: "{{ authentik_headlamp_provider_name }}"
      slug: "{{ authentik_headlamp_app_slug }}"
      provider: "{{ headlamp_provider_pk }}"
      meta_launch_url: "https://dashboard.{{ authentik_domain }}"
    status_code: 201
  no_log: true
  when: headlamp_app_check.json.pagination.count == 0

- name: Create Headlamp OIDC k8s secret
  become: false
  ansible.builtin.command: >-
    kubectl create secret generic {{ authentik_headlamp_secret_name }}
    -n {{ authentik_headlamp_secret_namespace }}
    --from-literal=OIDC_CLIENT_ID={{ headlamp_client_id }}
    --from-literal=OIDC_CLIENT_SECRET={{ headlamp_client_secret }}
    --from-literal=OIDC_ISSUER_URL=https://auth.{{ authentik_domain }}/application/o/{{ authentik_headlamp_app_slug }}/
    --from-literal=OIDC_SCOPES=openid,profile,email
  environment:
    KUBECONFIG: /home/debian/.kube/config
  no_log: true
  when: headlamp_secret_check.rc != 0
