---
# Configure Authentik via REST API
# Creates ForwardAuth provider, OIDC providers for Grafana/ArgoCD, and outpost config

- name: Read bootstrap token from k8s secret
  become: false
  ansible.builtin.command: >-
    kubectl get secret {{ authentik_secret_name }}
    -n {{ authentik_namespace }}
    -o jsonpath='{.data.AUTHENTIK_BOOTSTRAP_TOKEN}'
  environment:
    KUBECONFIG: /home/debian/.kube/config
  register: authentik_token_b64
  changed_when: false
  no_log: true

- name: Decode bootstrap token
  ansible.builtin.set_fact:
    authentik_api_token: "{{ authentik_token_b64.stdout | b64decode }}"
  no_log: true

- name: Start kubectl port-forward to Authentik
  become: false
  ansible.builtin.shell: >-
    kubectl port-forward svc/authentik-server
    -n {{ authentik_namespace }}
    {{ authentik_local_port }}:80 &
    echo $!
  environment:
    KUBECONFIG: /home/debian/.kube/config
  register: port_forward_pid
  changed_when: false

- name: Store port-forward PID
  ansible.builtin.set_fact:
    authentik_pf_pid: "{{ port_forward_pid.stdout_lines[-1] }}"

- name: Wait for Authentik API to be reachable
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/root/config/"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    status_code: 200
  register: api_check
  until: api_check.status == 200
  retries: 30
  delay: 5
  no_log: true

- name: Get default authorization flow
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/flows/instances/?designation=authorization"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: auth_flows
  no_log: true

- name: Set authorization flow UUID
  ansible.builtin.set_fact:
    authentik_authorization_flow: "{{ auth_flows.json.results[0].pk }}"

- name: Get default authentication flow
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/flows/instances/?designation=authentication"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: authn_flows
  no_log: true

- name: Set authentication flow UUID
  ansible.builtin.set_fact:
    authentik_authentication_flow: "{{ authn_flows.json.results[0].pk }}"

- name: Get OIDC scope property mappings
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/propertymappings/provider/scope/?ordering=scope_name"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: scope_mappings
  no_log: true

- name: Set scope mapping UUIDs
  ansible.builtin.set_fact:
    authentik_scope_mappings: "{{ scope_mappings.json.results | map(attribute='pk') | list }}"
    authentik_scope_email: "{{ scope_mappings.json.results | selectattr('scope_name', 'equalto', 'email') | map(attribute='pk') | first }}"
    authentik_scope_openid: "{{ scope_mappings.json.results | selectattr('scope_name', 'equalto', 'openid') | map(attribute='pk') | first }}"
    authentik_scope_profile: "{{ scope_mappings.json.results | selectattr('scope_name', 'equalto', 'profile') | map(attribute='pk') | first }}"

- name: Configure ForwardAuth provider and application
  ansible.builtin.include_tasks: forwardauth.yml

- name: Configure Grafana OIDC provider and application
  ansible.builtin.include_tasks: oidc-grafana.yml

- name: Configure ArgoCD OIDC provider and application
  ansible.builtin.include_tasks: oidc-argocd.yml

- name: Configure embedded outpost
  ansible.builtin.include_tasks: outpost.yml

- name: Kill port-forward process
  ansible.builtin.command: "kill {{ authentik_pf_pid }}"
  changed_when: false
  failed_when: false
