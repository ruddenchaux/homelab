---
# Create Immich OAuth2 provider, application, and k8s secret with config file

- name: Check if Immich OIDC secret exists
  become: false
  ansible.builtin.command: >-
    kubectl get secret {{ authentik_immich_secret_name }}
    -n {{ authentik_immich_secret_namespace }}
  environment:
    KUBECONFIG: /home/debian/.kube/config
  register: immich_secret_check
  changed_when: false
  failed_when: false

- name: Generate Immich client credentials
  when: immich_secret_check.rc != 0
  block:
    - name: Generate Immich client ID
      become: false
      ansible.builtin.command: openssl rand -hex 20
      register: immich_client_id_result
      changed_when: false
      no_log: true

    - name: Generate Immich client secret
      become: false
      ansible.builtin.command: openssl rand -hex 40
      register: immich_client_secret_result
      changed_when: false
      no_log: true

    - name: Set Immich client credentials
      ansible.builtin.set_fact:
        immich_client_id: "{{ immich_client_id_result.stdout }}"
        immich_client_secret: "{{ immich_client_secret_result.stdout }}"
      no_log: true

- name: Load existing Immich client credentials from secret
  when: immich_secret_check.rc == 0
  block:
    - name: Read Immich client ID from secret
      become: false
      ansible.builtin.command: >-
        kubectl get secret {{ authentik_immich_secret_name }}
        -n {{ authentik_immich_secret_namespace }}
        -o jsonpath='{.data.client-id}'
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: immich_existing_id
      changed_when: false
      no_log: true

    - name: Read Immich client secret from secret
      become: false
      ansible.builtin.command: >-
        kubectl get secret {{ authentik_immich_secret_name }}
        -n {{ authentik_immich_secret_namespace }}
        -o jsonpath='{.data.client-secret}'
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: immich_existing_secret
      changed_when: false
      no_log: true

    - name: Set Immich client credentials from existing secret
      ansible.builtin.set_fact:
        immich_client_id: "{{ immich_existing_id.stdout | b64decode }}"
        immich_client_secret: "{{ immich_existing_secret.stdout | b64decode }}"
      no_log: true

- name: Check if Immich OAuth2 provider exists
  become: false
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/providers/oauth2/?name={{ authentik_immich_provider_name | urlencode }}"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: immich_provider_check
  no_log: true

- name: Create Immich OAuth2 provider
  become: false
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/providers/oauth2/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
      Content-Type: application/json
    body_format: json
    body:
      name: "{{ authentik_immich_provider_name }}"
      client_type: confidential
      client_id: "{{ immich_client_id }}"
      client_secret: "{{ immich_client_secret }}"
      redirect_uris:
        - matching_mode: strict
          url: "https://immich.{{ authentik_domain }}/auth/login"
        - matching_mode: strict
          url: "https://immich.{{ authentik_domain }}/user-settings"
        - matching_mode: strict
          url: "app.immich:///oauth-callback"
      authorization_flow: "{{ authentik_authorization_flow }}"
      authentication_flow: "{{ authentik_authentication_flow }}"
      invalidation_flow: "{{ authentik_invalidation_flow }}"
      signing_key: "{{ authentik_signing_key }}"
      property_mappings:
        - "{{ authentik_scope_openid }}"
        - "{{ authentik_scope_email }}"
        - "{{ authentik_scope_profile }}"
    status_code: 201
  register: immich_provider_created
  no_log: true
  when: immich_provider_check.json.pagination.count == 0

- name: Set Immich provider PK
  ansible.builtin.set_fact:
    immich_provider_pk: >-
      {{ (immich_provider_check.json.pagination.count > 0)
         | ternary(immich_provider_check.json.results[0].pk,
                   immich_provider_created.json.pk) }}

- name: Check if Immich application exists
  become: false
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/core/applications/?slug={{ authentik_immich_app_slug }}"
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
    return_content: true
  register: immich_app_check
  no_log: true

- name: Create Immich application
  become: false
  ansible.builtin.uri:
    url: "http://localhost:{{ authentik_local_port }}/api/v3/core/applications/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_api_token }}"
      Content-Type: application/json
    body_format: json
    body:
      name: "{{ authentik_immich_provider_name }}"
      slug: "{{ authentik_immich_app_slug }}"
      provider: "{{ immich_provider_pk }}"
      meta_launch_url: "https://immich.{{ authentik_domain }}"
    status_code: 201
  no_log: true
  when: immich_app_check.json.pagination.count == 0

- name: Build Immich OAuth config JSON
  ansible.builtin.set_fact:
    immich_config_json: "{{ immich_oauth_config | to_json }}"
  vars:
    immich_oauth_config:
      oauth:
        enabled: true
        issuerUrl: "{{ authentik_external_url }}/application/o/{{ authentik_immich_app_slug }}/"
        clientId: "{{ immich_client_id }}"
        clientSecret: "{{ immich_client_secret }}"
        autoRegister: true
        autoLaunch: true
        buttonText: "Login with Authentik"
        scope: "openid email profile"
        signingAlgorithm: "RS256"
        storageLabelClaim: "preferred_username"
  no_log: true

- name: Create Immich OIDC k8s secret
  become: false
  ansible.builtin.command:
    argv:
      - kubectl
      - create
      - secret
      - generic
      - "{{ authentik_immich_secret_name }}"
      - "-n"
      - "{{ authentik_immich_secret_namespace }}"
      - "--from-literal=client-id={{ immich_client_id }}"
      - "--from-literal=client-secret={{ immich_client_secret }}"
      - "--from-literal=immich.json={{ immich_config_json }}"
  environment:
    KUBECONFIG: /home/debian/.kube/config
  no_log: true
  when: immich_secret_check.rc != 0
