---
# Configure qBittorrent via Web API using kubectl exec (localhost auth bypass)
# API docs: https://github.com/qbittorrent/qBittorrent/wiki/WebUI-API-(qBittorrent-4.1)
# qBittorrent has WebUI\LocalHostAuth=false, so requests from inside the
# container bypass authentication. This avoids temp password issues.

- name: Login to qBittorrent via localhost
  become: false
  ansible.builtin.shell: >-
    kubectl exec deploy/qbittorrent -c qbittorrent -n {{ media_namespace }}
    -- curl -sf -X POST http://localhost:{{ media_qbittorrent_port }}/api/v2/auth/login
    -d 'username=admin&password=admin' -c /tmp/cookies.txt
  environment:
    KUBECONFIG: /home/debian/.kube/config
  changed_when: false

- name: Set known admin password
  become: false
  ansible.builtin.shell: >-
    kubectl exec deploy/qbittorrent -c qbittorrent -n {{ media_namespace }}
    -- curl -sf -X POST http://localhost:{{ media_qbittorrent_port }}/api/v2/app/setPreferences
    -b /tmp/cookies.txt
    -d 'json={"web_ui_password":"{{ media_qbt_admin_password }}"}'
  environment:
    KUBECONFIG: /home/debian/.kube/config
  changed_when: false
  no_log: true

- name: Set qBittorrent download preferences
  become: false
  ansible.builtin.shell: >-
    kubectl exec deploy/qbittorrent -c qbittorrent -n {{ media_namespace }}
    -- curl -sf -X POST http://localhost:{{ media_qbittorrent_port }}/api/v2/app/setPreferences
    -b /tmp/cookies.txt
    -d 'json={{ media_qbt_preferences | to_json }}'
  environment:
    KUBECONFIG: /home/debian/.kube/config
  changed_when: false

- name: Get existing qBittorrent categories
  become: false
  ansible.builtin.shell: >-
    kubectl exec deploy/qbittorrent -c qbittorrent -n {{ media_namespace }}
    -- curl -sf http://localhost:{{ media_qbittorrent_port }}/api/v2/torrents/categories
    -b /tmp/cookies.txt
  environment:
    KUBECONFIG: /home/debian/.kube/config
  register: qbt_existing_categories
  changed_when: false

- name: Create qBittorrent categories
  become: false
  ansible.builtin.shell: >-
    kubectl exec deploy/qbittorrent -c qbittorrent -n {{ media_namespace }}
    -- curl -sf -X POST http://localhost:{{ media_qbittorrent_port }}/api/v2/torrents/createCategory
    -b /tmp/cookies.txt
    -d 'category={{ item.key }}&savePath={{ item.value.savePath }}'
  environment:
    KUBECONFIG: /home/debian/.kube/config
  loop: "{{ media_qbt_categories | dict2items }}"
  when: item.key not in (qbt_existing_categories.stdout | from_json | default({}))
  changed_when: true

- name: Update qBittorrent category save paths
  become: false
  ansible.builtin.shell: >-
    kubectl exec deploy/qbittorrent -c qbittorrent -n {{ media_namespace }}
    -- curl -s -X POST http://localhost:{{ media_qbittorrent_port }}/api/v2/torrents/editCategory
    -b /tmp/cookies.txt
    -d 'category={{ item.key }}&savePath={{ item.value.savePath }}'
  environment:
    KUBECONFIG: /home/debian/.kube/config
  loop: "{{ media_qbt_categories | dict2items }}"
  when: >-
    item.key in (qbt_existing_categories.stdout | from_json | default({})) and
    (qbt_existing_categories.stdout | from_json)[item.key].savePath != item.value.savePath
  changed_when: true
