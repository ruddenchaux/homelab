---
# Configure Lidarr via API v1
# - Add root folder for music
# - Add qBittorrent as download client

- name: Configure Lidarr naming (enable track renaming with Artist/Album/Track structure)
  become: false
  ansible.builtin.uri:
    url: "{{ media_lidarr_url }}/api/v1/config/naming"
    method: PUT
    headers:
      X-Api-Key: "{{ media_lidarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      renameTracks: true
      replaceIllegalCharacters: true
      colonReplacementFormat: 4
      standardTrackFormat: "{Album Title} ({Release Year})/{Artist Name} - {Album Title} - {track:00} - {Track Title}"
      multiDiscTrackFormat: "{Album Title} ({Release Year})/{Medium Format} {medium:00}/{Artist Name} - {Album Title} - {track:00} - {Track Title}"
      artistFolderFormat: "{Artist Name}"
      includeArtistName: false
      includeAlbumTitle: false
      includeQuality: false
      replaceSpaces: false
      id: 1
    status_code: 200
  no_log: true

- name: Check existing Lidarr root folders
  become: false
  ansible.builtin.uri:
    url: "{{ media_lidarr_url }}/api/v1/rootfolder"
    headers:
      X-Api-Key: "{{ media_lidarr_api_key }}"
    return_content: true
  register: lidarr_root_folders
  no_log: true

- name: Add Lidarr root folder
  become: false
  ansible.builtin.uri:
    url: "{{ media_lidarr_url }}/api/v1/rootfolder"
    method: POST
    headers:
      X-Api-Key: "{{ media_lidarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      path: "{{ media_music_path }}"
      name: Music
      defaultQualityProfileId: 1
      defaultMetadataProfileId: 1
    status_code: 201
  no_log: true
  when: media_music_path not in (lidarr_root_folders.json | map(attribute='path') | list)

- name: Check existing Lidarr download clients
  become: false
  ansible.builtin.uri:
    url: "{{ media_lidarr_url }}/api/v1/downloadclient"
    headers:
      X-Api-Key: "{{ media_lidarr_api_key }}"
    return_content: true
  register: lidarr_download_clients
  no_log: true

- name: Add qBittorrent to Lidarr
  become: false
  ansible.builtin.uri:
    url: "{{ media_lidarr_url }}/api/v1/downloadclient"
    method: POST
    headers:
      X-Api-Key: "{{ media_lidarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      enable: true
      protocol: torrent
      name: qBittorrent
      implementation: QBittorrent
      configContract: QBittorrentSettings
      priority: 1
      fields:
        - name: host
          value: "qbittorrent.{{ media_namespace }}.svc.cluster.local"
        - name: port
          value: "{{ media_qbittorrent_port }}"
        - name: username
          value: admin
        - name: password
          value: "{{ media_qbt_admin_password }}"
        - name: musicCategory
          value: music
        - name: useSsl
          value: false
    status_code:
      - 201
      - 400
  register: lidarr_qbt_result
  no_log: true
  when: "'qBittorrent' not in (lidarr_download_clients.json | map(attribute='name') | list)"

- name: Warn if qBittorrent connection failed for Lidarr
  ansible.builtin.debug:
    msg: "qBittorrent download client not added to Lidarr - configure qBittorrent password first, then re-run"
  when: lidarr_qbt_result.status | default(0) == 400
