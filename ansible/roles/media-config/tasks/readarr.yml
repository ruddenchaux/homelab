---
# Configure Readarr via API v1
# - Add root folder for books
# - Add qBittorrent as download client

- name: Check existing Readarr root folders
  become: false
  ansible.builtin.uri:
    url: "{{ media_readarr_url }}/api/v1/rootfolder"
    headers:
      X-Api-Key: "{{ media_readarr_api_key }}"
    return_content: true
  register: readarr_root_folders
  no_log: true

- name: Add Readarr root folder
  become: false
  ansible.builtin.uri:
    url: "{{ media_readarr_url }}/api/v1/rootfolder"
    method: POST
    headers:
      X-Api-Key: "{{ media_readarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      path: "{{ media_books_path }}"
      name: Books
    status_code: 201
  no_log: true
  when: media_books_path not in (readarr_root_folders.json | map(attribute='path') | list)

- name: Check existing Readarr download clients
  become: false
  ansible.builtin.uri:
    url: "{{ media_readarr_url }}/api/v1/downloadclient"
    headers:
      X-Api-Key: "{{ media_readarr_api_key }}"
    return_content: true
  register: readarr_download_clients
  no_log: true

- name: Add qBittorrent to Readarr
  become: false
  ansible.builtin.uri:
    url: "{{ media_readarr_url }}/api/v1/downloadclient"
    method: POST
    headers:
      X-Api-Key: "{{ media_readarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      enable: true
      protocol: torrent
      name: qBittorrent
      implementation: QBittorrent
      configContract: QBittorrentSettings
      fields:
        - name: host
          value: "qbittorrent.{{ media_namespace }}.svc.cluster.local"
        - name: port
          value: "{{ media_qbittorrent_port }}"
        - name: username
          value: admin
        - name: password
          value: adminadmin
        - name: bookCategory
          value: books
        - name: bookImportedCategory
          value: ""
        - name: recentBookPriority
          value: 0
        - name: olderBookPriority
          value: 0
        - name: initialState
          value: 0
        - name: useSsl
          value: false
    status_code: 201
  no_log: true
  when: "'qBittorrent' not in (readarr_download_clients.json | map(attribute='name') | list)"
