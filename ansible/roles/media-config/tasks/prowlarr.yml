---
# Configure Prowlarr via API v1
# - Add FlareSolverr as indexer proxy
# - Add all *arr apps as sync targets (applications)
# Prowlarr will auto-sync indexers to connected apps

# --- FlareSolverr indexer proxy ---
- name: Check existing Prowlarr tags
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/tag"
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
    return_content: true
  register: prowlarr_tags
  no_log: true

- name: Create flaresolverr tag
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/tag"
    method: POST
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      label: flaresolverr
    status_code: 201
  register: flaresolverr_tag_result
  no_log: true
  when: "'flaresolverr' not in (prowlarr_tags.json | map(attribute='label') | list)"

- name: Store flaresolverr tag ID
  ansible.builtin.set_fact:
    media_flaresolverr_tag_id: >-
      {{ (flaresolverr_tag_result.json.id | default(0)) if flaresolverr_tag_result is changed
         else (prowlarr_tags.json | selectattr('label', 'equalto', 'flaresolverr') | map(attribute='id') | first | default(0)) }}

- name: Check existing Prowlarr indexer proxies
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/indexerProxy"
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
    return_content: true
  register: prowlarr_proxies
  no_log: true

- name: Add FlareSolverr indexer proxy
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/indexerProxy"
    method: POST
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      name: FlareSolverr
      implementation: FlareSolverr
      configContract: FlareSolverrSettings
      fields:
        - name: host
          value: "http://flaresolverr.{{ media_namespace }}.svc.cluster.local:{{ media_flaresolverr_port }}/"
        - name: requestTimeout
          value: 60
      tags:
        - "{{ media_flaresolverr_tag_id | int }}"
    status_code: 201
  no_log: true
  when: "'FlareSolverr' not in (prowlarr_proxies.json | map(attribute='name') | list)"

# --- Applications ---
- name: Check existing Prowlarr applications
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/applications"
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
    return_content: true
  register: prowlarr_apps
  no_log: true

- name: Set existing Prowlarr app names
  ansible.builtin.set_fact:
    prowlarr_existing_apps: "{{ prowlarr_apps.json | map(attribute='name') | list }}"

- name: Add Radarr to Prowlarr
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/applications"
    method: POST
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      syncLevel: fullSync
      name: Radarr
      implementation: Radarr
      configContract: RadarrSettings
      fields:
        - name: prowlarrUrl
          value: "http://prowlarr.{{ media_namespace }}.svc.cluster.local:{{ media_prowlarr_port }}"
        - name: baseUrl
          value: "http://radarr.{{ media_namespace }}.svc.cluster.local:{{ media_radarr_port }}"
        - name: apiKey
          value: "{{ media_radarr_api_key }}"
        - name: syncCategories
          value: "{{ media_prowlarr_sync_categories.radarr }}"
    status_code: 201
  no_log: true
  when: "'Radarr' not in prowlarr_existing_apps"

- name: Add Sonarr to Prowlarr
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/applications"
    method: POST
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      syncLevel: fullSync
      name: Sonarr
      implementation: Sonarr
      configContract: SonarrSettings
      fields:
        - name: prowlarrUrl
          value: "http://prowlarr.{{ media_namespace }}.svc.cluster.local:{{ media_prowlarr_port }}"
        - name: baseUrl
          value: "http://sonarr.{{ media_namespace }}.svc.cluster.local:{{ media_sonarr_port }}"
        - name: apiKey
          value: "{{ media_sonarr_api_key }}"
        - name: syncCategories
          value: "{{ media_prowlarr_sync_categories.sonarr }}"
    status_code: 201
  no_log: true
  when: "'Sonarr' not in prowlarr_existing_apps"

- name: Add Lidarr to Prowlarr
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/applications"
    method: POST
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      syncLevel: fullSync
      name: Lidarr
      implementation: Lidarr
      configContract: LidarrSettings
      fields:
        - name: prowlarrUrl
          value: "http://prowlarr.{{ media_namespace }}.svc.cluster.local:{{ media_prowlarr_port }}"
        - name: baseUrl
          value: "http://lidarr.{{ media_namespace }}.svc.cluster.local:{{ media_lidarr_port }}"
        - name: apiKey
          value: "{{ media_lidarr_api_key }}"
        - name: syncCategories
          value: "{{ media_prowlarr_sync_categories.lidarr }}"
    status_code: 201
  no_log: true
  when: "'Lidarr' not in prowlarr_existing_apps"

- name: Add Readarr to Prowlarr
  become: false
  ansible.builtin.uri:
    url: "{{ media_prowlarr_url }}/api/v1/applications"
    method: POST
    headers:
      X-Api-Key: "{{ media_prowlarr_api_key }}"
      Content-Type: application/json
    body_format: json
    body:
      syncLevel: fullSync
      name: Readarr
      implementation: Readarr
      configContract: ReadarrSettings
      fields:
        - name: prowlarrUrl
          value: "http://prowlarr.{{ media_namespace }}.svc.cluster.local:{{ media_prowlarr_port }}"
        - name: baseUrl
          value: "http://readarr.{{ media_namespace }}.svc.cluster.local:{{ media_readarr_port }}"
        - name: apiKey
          value: "{{ media_readarr_api_key }}"
        - name: syncCategories
          value: "{{ media_prowlarr_sync_categories.readarr }}"
    status_code: 201
  no_log: true
  when: "'Readarr' not in prowlarr_existing_apps"
