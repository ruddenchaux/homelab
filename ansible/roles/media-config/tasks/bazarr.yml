---
# Configure Bazarr via config file editing
# The REST API (POST /api/system/settings) silently discards updates in v1.5.5
# - Enable Radarr + Sonarr integrations (use_radarr, use_sonarr)
# - Set connection details (ip, port, apikey)

- name: Check Bazarr config
  become: false
  ansible.builtin.uri:
    url: "{{ media_bazarr_url }}/api/system/settings"
    headers:
      X-API-KEY: "{{ media_bazarr_api_key }}"
    return_content: true
  register: bazarr_settings
  no_log: true

- name: Configure Bazarr via config file
  when: >-
    bazarr_settings.json.radarr.apikey | default('') == '' or
    bazarr_settings.json.sonarr.apikey | default('') == '' or
    not (bazarr_settings.json.general.use_radarr | default(false)) or
    not (bazarr_settings.json.general.use_sonarr | default(false)) or
    not (bazarr_settings.json.general.serie_default_enabled | default(false)) or
    not (bazarr_settings.json.general.movie_default_enabled | default(false)) or
    not (bazarr_settings.json.general.adaptive_searching | default(false)) or
    not (bazarr_settings.json.general.use_embedded_subs | default(false)) or
    not (bazarr_settings.json.general.embedded_subs_show_desired | default(false))
  block:
    - name: Get Bazarr pod name
      become: false
      ansible.builtin.command: >-
        kubectl get pod -n {{ media_namespace }}
        -l app.kubernetes.io/name=bazarr
        -o jsonpath='{.items[0].metadata.name}'
      environment:
        KUBECONFIG: /home/debian/.kube/config
      register: bazarr_pod
      changed_when: false

    - name: Copy Bazarr config from pod
      become: false
      ansible.builtin.command: >-
        kubectl cp {{ media_namespace }}/{{ bazarr_pod.stdout }}:/config/config/config.yaml
        /tmp/bazarr-config.yaml
      environment:
        KUBECONFIG: /home/debian/.kube/config
      changed_when: false

    - name: Update Bazarr config file
      become: false
      ansible.builtin.shell: |
        python3 -c "
        import yaml
        with open('/tmp/bazarr-config.yaml') as f:
            cfg = yaml.safe_load(f)
        cfg['radarr']['ip'] = 'radarr.{{ media_namespace }}.svc.cluster.local'
        cfg['radarr']['port'] = {{ media_radarr_port }}
        cfg['radarr']['apikey'] = '{{ media_radarr_api_key }}'
        cfg['radarr']['ssl'] = False
        cfg['sonarr']['ip'] = 'sonarr.{{ media_namespace }}.svc.cluster.local'
        cfg['sonarr']['port'] = {{ media_sonarr_port }}
        cfg['sonarr']['apikey'] = '{{ media_sonarr_api_key }}'
        cfg['sonarr']['ssl'] = False
        cfg['general']['use_radarr'] = True
        cfg['general']['use_sonarr'] = True
        cfg['general']['serie_default_enabled'] = True
        cfg['general']['movie_default_enabled'] = True
        cfg['general']['adaptive_searching'] = True
        cfg['general']['use_embedded_subs'] = True
        cfg['general']['embedded_subs_show_desired'] = True
        with open('/tmp/bazarr-config.yaml', 'w') as f:
            yaml.dump(cfg, f, default_flow_style=False, sort_keys=True)
        print('Bazarr config updated')
        "
      changed_when: true

    - name: Copy config back to Bazarr pod
      become: false
      ansible.builtin.command: >-
        kubectl cp /tmp/bazarr-config.yaml
        {{ media_namespace }}/{{ bazarr_pod.stdout }}:/config/config/config.yaml
      environment:
        KUBECONFIG: /home/debian/.kube/config
      changed_when: true

    - name: Restart Bazarr to apply config
      become: false
      ansible.builtin.command: >-
        kubectl rollout restart deployment/bazarr -n {{ media_namespace }}
      environment:
        KUBECONFIG: /home/debian/.kube/config
      changed_when: true

    - name: Wait for Bazarr rollout
      become: false
      ansible.builtin.command: >-
        kubectl rollout status deployment/bazarr
        -n {{ media_namespace }}
        --timeout=120s
      environment:
        KUBECONFIG: /home/debian/.kube/config
      changed_when: false

    - name: Clean up temp config
      ansible.builtin.file:
        path: /tmp/bazarr-config.yaml
        state: absent
