---
- name: Install nfs-kernel-server
  ansible.builtin.apt:
    name: nfs-kernel-server
    state: present
    update_cache: true

- name: Create ZFS dataset for media library
  community.general.zfs:
    name: "{{ nfs_zfs_dataset }}"
    state: present
    extra_zfs_properties:
      compression: lz4
      atime: off
      quota: "{{ nfs_media_quota }}"

- name: Set ownership on media dataset
  ansible.builtin.file:
    path: "{{ nfs_export_path }}"
    state: directory
    mode: "0755"
    owner: "{{ nfs_media_owner }}"
    group: "{{ nfs_media_group }}"

- name: Configure NFS export for media library
  ansible.builtin.lineinfile:
    path: /etc/exports
    line: "{{ nfs_export_path }} {{ nfs_allowed_network }}({{ nfs_export_options }})"
    state: present
  notify: Re-export NFS shares

- name: Enable and start nfs-server
  ansible.builtin.systemd:
    name: nfs-server
    state: started
    enabled: true
