---
- name: Install qrencode (for generating scannable QR code)
  ansible.builtin.apt:
    name: qrencode
    state: present

- name: Read VPS public key (needed for client config Endpoint peer)
  ansible.builtin.slurp:
    src: /etc/wireguard/public.key
  register: _vps_public_key_raw

- name: Set VPS public key fact
  ansible.builtin.set_fact:
    vps_wg_public_key: "{{ _vps_public_key_raw.content | b64decode | trim }}"

- name: Build client config content
  ansible.builtin.set_fact:
    vpn_client_conf: |
      [Interface]
      PrivateKey = {{ vpn_client_private_key }}
      Address = {{ vpn_client_ip }}/24
      DNS = {{ vpn_dns }}

      [Peer]
      PublicKey = {{ vps_wg_public_key }}
      Endpoint = {{ vps_public_ip }}:{{ vps_wg_port }}
      AllowedIPs = {{ vpn_homelab_cidrs | join(', ') }}
      PersistentKeepalive = 25
  no_log: true

- name: Save client config to file on VPS
  ansible.builtin.copy:
    content: "{{ vpn_client_conf }}"
    dest: /etc/wireguard/clients/{{ vpn_client_name }}.conf
    mode: "0600"
  no_log: true

- name: Generate QR code as PNG on VPS
  ansible.builtin.shell:
    cmd: "qrencode -t png -o /etc/wireguard/clients/{{ vpn_client_name }}.png < /etc/wireguard/clients/{{ vpn_client_name }}.conf"
  changed_when: true
  no_log: true

- name: Fetch QR code PNG to local machine
  ansible.builtin.fetch:
    src: /etc/wireguard/clients/{{ vpn_client_name }}.png
    dest: "{{ playbook_dir }}/../../{{ vpn_client_name }}-vpn-qr.png"
    flat: true
  no_log: true

- name: Display instructions
  ansible.builtin.debug:
    msg: |
      QR code saved to: {{ vpn_client_name }}-vpn-qr.png (open with any image viewer)
      Client config also on VPS at: /etc/wireguard/clients/{{ vpn_client_name }}.conf
      VPN routes (split tunnel): {{ vpn_homelab_cidrs | join(', ') }}
