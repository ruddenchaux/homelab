---
- name: Enable IPv4 forwarding (persistent)
  ansible.builtin.lineinfile:
    path: /etc/sysctl.d/99-wireguard-forward.conf
    line: "net.ipv4.ip_forward = 1"
    create: true
    mode: "0644"
    state: present

- name: Apply sysctl setting immediately
  ansible.builtin.command: sysctl -p /etc/sysctl.d/99-wireguard-forward.conf
  changed_when: false

# UFW is present on Debian VPS images and defaults FORWARD to DROP.
# A WireGuard relay needs to forward packets between peers â€” ACCEPT is correct here
# because WireGuard's cryptographic auth (not iptables) is the security boundary.
- name: Set UFW forward policy to ACCEPT
  ansible.builtin.lineinfile:
    path: /etc/default/ufw
    regexp: '^DEFAULT_FORWARD_POLICY='
    line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
  notify: reload ufw
